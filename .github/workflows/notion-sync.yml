name: Sync GitHub Activity to Notion

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, closed, reopened, edited]
  workflow_dispatch:

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get commit information
        if: github.event_name == 'push'
        id: commit_info
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%cI)
          COMMIT_URL="${{ github.event.repository.html_url }}/commit/$COMMIT_SHA"
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Get stats
          FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r $COMMIT_SHA | wc -l)
          ADDITIONS=$(git show --shortstat $COMMIT_SHA | grep -oP '\d+(?= insertion)' || echo "0")
          DELETIONS=$(git show --shortstat $COMMIT_SHA | grep -oP '\d+(?= deletion)' || echo "0")
          
          echo "sha=$COMMIT_SHORT_SHA" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "url=$COMMIT_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT

      - name: Get PR information
        if: github.event_name == 'pull_request'
        id: pr_info
        run: |
          # Escape special characters for JSON
          PR_TITLE=$(echo '${{ github.event.pull_request.title }}' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_STATE="${{ github.event.pull_request.state }}"
          PR_MERGED="${{ github.event.pull_request.merged }}"
          FILES_CHANGED="${{ github.event.pull_request.changed_files }}"
          ADDITIONS="${{ github.event.pull_request.additions }}"
          DELETIONS="${{ github.event.pull_request.deletions }}"
          
          # Handle body with multiline support
          PR_BODY=$(echo '${{ github.event.pull_request.body }}' | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr '\n' ' ' | cut -c1-2000)
          
          # Use correct date based on action
          if [ "${{ github.event.action }}" == "closed" ]; then
            PR_DATE="${{ github.event.pull_request.closed_at }}"
          else
            PR_DATE="${{ github.event.pull_request.created_at }}"
          fi
          
          # Determine status
          if [ "$PR_MERGED" == "true" ]; then
            STATUS="Merged"
          elif [ "$PR_STATE" == "closed" ]; then
            STATUS="Closed"
          else
            STATUS="Open"
          fi
          
          # Output with proper escaping
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "date=$PR_DATE" >> $GITHUB_OUTPUT
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT

      - name: Send Commit to Notion
        if: github.event_name == 'push'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # Create JSON payload with proper escaping
          PAYLOAD=$(cat <<EOF
          {
            "parent": { "database_id": "$NOTION_DATABASE_ID" },
            "properties": {
              "Activity": {
                "title": [
                  {
                    "text": {
                      "content": "${{ steps.commit_info.outputs.message }}"
                    }
                  }
                ]
              },
              "Type": {
                "select": {
                  "name": "Commit"
                }
              },
              "Repository": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ github.repository }}"
                    }
                  }
                ]
              },
              "Author": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.commit_info.outputs.author }}"
                    }
                  }
                ]
              },
              "Date": {
                "date": {
                  "start": "${{ steps.commit_info.outputs.date }}"
                }
              },
              "URL": {
                "url": "${{ steps.commit_info.outputs.url }}"
              },
              "Branch": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.commit_info.outputs.branch }}"
                    }
                  }
                ]
              },
              "Status": {
                "select": {
                  "name": "Completed"
                }
              },
              "SHA": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.commit_info.outputs.sha }}"
                    }
                  }
                ]
              },
              "Files Changed": {
                "number": ${{ steps.commit_info.outputs.files }}
              },
              "Additions": {
                "number": ${{ steps.commit_info.outputs.additions }}
              },
              "Deletions": {
                "number": ${{ steps.commit_info.outputs.deletions }}
              }
            }
          }
          EOF
          )
          
          # Send to Notion with error handling
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "$PAYLOAD")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Commit synced successfully to Notion (HTTP $HTTP_CODE)"
          else
            echo "❌ Failed to sync commit to Notion (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Debug PR Info
        if: github.event_name == 'pull_request'
        run: |
          echo "🔍 PR Information:"
          echo "  Action: ${{ github.event.action }}"
          echo "  Title: ${{ steps.pr_info.outputs.title }}"
          echo "  Author: ${{ steps.pr_info.outputs.author }}"
          echo "  Status: ${{ steps.pr_info.outputs.status }}"
          echo "  Date: ${{ steps.pr_info.outputs.date }}"
          echo "  Files: ${{ steps.pr_info.outputs.files }}"

      - name: Send PR to Notion
        if: github.event_name == 'pull_request'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # Create JSON payload with proper escaping
          PAYLOAD=$(cat <<EOF
          {
            "parent": { "database_id": "$NOTION_DATABASE_ID" },
            "properties": {
              "Activity": {
                "title": [
                  {
                    "text": {
                      "content": "${{ steps.pr_info.outputs.title }}"
                    }
                  }
                ]
              },
              "Type": {
                "select": {
                  "name": "Pull Request"
                }
              },
              "Repository": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ github.repository }}"
                    }
                  }
                ]
              },
              "Author": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.pr_info.outputs.author }}"
                    }
                  }
                ]
              },
              "Date": {
                "date": {
                  "start": "${{ steps.pr_info.outputs.date }}"
                }
              },
              "URL": {
                "url": "${{ steps.pr_info.outputs.url }}"
              },
              "Branch": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.pr_info.outputs.branch }}"
                    }
                  }
                ]
              },
              "Status": {
                "select": {
                  "name": "${{ steps.pr_info.outputs.status }}"
                }
              },
              "Description": {
                "rich_text": [
                  {
                    "text": {
                      "content": "${{ steps.pr_info.outputs.body }}"
                    }
                  }
                ]
              },
              "Files Changed": {
                "number": ${{ steps.pr_info.outputs.files }}
              },
              "Additions": {
                "number": ${{ steps.pr_info.outputs.additions }}
              },
              "Deletions": {
                "number": ${{ steps.pr_info.outputs.deletions }}
              }
            }
          }
          EOF
          )
          
          # Send to Notion with error handling
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "$PAYLOAD")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ PR synced successfully to Notion (HTTP $HTTP_CODE)"
          else
            echo "❌ Failed to sync PR to Notion (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Workflow completed
        run: |
          echo "✅ Activity synced to Notion successfully!"
